!function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){
/*
* @module uniSoc
* @author plundell
* @license Apache-2.0
* @description Frontend component of uniSoc. Wraps around native WebSocket API (https://developer.mozilla.org/en-US/docs/Web/API/WebSocket)
* @extends ./unisoc-common.js   
* @depends libbetter
* @exports n/a      This script should be bundled and loaded in the browser directly. It make the module available 
*                   available at window.uniSoc. If you want to require the web-component of uniSoc @see ./unisoc-web.js
*/
!function(){if(!window)throw new Error("Could not access the 'window'. Cannot load uniSoc.");n(1);Object.defineProperty(window,"uniSoc",{enumerable:!0,configurable:!0,get:()=>{if(window.BetterLog&&window.BetterEvents&&window.BetterUtil)return window.uniSoc=proto(window);throw new Error("E_DEPENDENCY. uniSoc depends on libbetter which should be set on the window.")},set:e=>(Object.defineProperty(window,"uniSoc",{value:e,enumerable:!0,writable:!0,configurable:!0}),e)})}()},function(e,t,n){
/*
* @module uniSoc
* @author plundell
* @license Apache-2.0
* @description Frontend component of uniSoc. Wraps around native WebSocket API (https://developer.mozilla.org/en-US/docs/Web/API/WebSocket)
*
* @extends ./unisoc-common.js 	
* @depends libbetter
*
* This script can be required by another script or bundled and loaded in the browser directly, making
* it available at window.uniSoc
*
*/
e.exports=function(e={}){const t=n(2)(e),r=e.BetterUtil;function o(e){t.Websocket.call(this,Object.assign({},o.defaultOptions,e));this.on("_connect",()=>this.log.info("CONNECTED"))}return o.defaultOptions={reconnectTimeout:5e3},o.prototype=Object.create(t.Websocket.prototype),Object.defineProperty(o.prototype,"constructor",{value:o}),o.prototype.connect=function(e,t){try{this.connected&&this.log.makeError("Already connected").throw("EALREADY"),t="reconnect"==t,e&&Object.assign(this._options,e);var n="//"+(this._options.host?this._options.host:document.location.host);this._options.port&&(n+=":"+this._options.port),n=("https:"==document.location.protocol?"wss:":"ws:")+n,t||this.log.info("Attempting to connect to websocket:",n).exec(),this.socket=new WebSocket(n,"json"),this.registerAllListeners();var{promise:o,resolve:i,reject:s,inspect:c}=r.exposedPromise(5e3);this.once("_connect",i),this.once("_disconnect",s);var a=(new Error).stack;return o.then(()=>{this.off("_disconnect",s),this.once("_disconnect",()=>this.reconnect())},e=>{this.off("_connect",i);let n=this.log.makeError(e,this.socket).setStack(a);if(this.socket=null,!t)return n.reject();n.prepend("Reconnect failed."),1006==n.code?(n.changeLvl("debug").printed=!0,n.exec()):n.exec(),this.reconnect()})}catch(e){let n=this.log.makeError(e).prepend("BUGBUG:");if(!t)return n.reject();n.exec()}},o.prototype.reconnect=function(e){e&&"number"==typeof e&&(this._options.reconnectTimeout=e),(e=this._options.reconnectTimeout)?(this.log.trace(`Trying to reconnect in ${e} ms.`),setTimeout(()=>this.connect(null,"reconnect"),e)):this.log.note("Not reconnecting. See this._options.reconnectTimeout")},o.prototype.abortReconnect=function(){this._options.reconnectTimeout=null},o}},function(e,t,n){"use strict";
/*
* @module uniSoc
* @author plundell
* @license Apache2
* @description Unified API for various socket transports with question/answer protocol
* 
* This class can be required in NodeJS by uniSoc.node.js or uniSoc.web.js, or it can be loaded 
* directly in the browser. If required it will export a function which should be called with the
* dependencies, if loaded it expects the dependencies to be set on the global object prior to loading
*
* It provides the common bits of the uniSoc package used by both flavors (nodejs and browser)
*
* @depends BetterEvents
* @depends BetterLog
* @depends BetterUtil.common
*
* @exports function({dependencies}) 	It exports a function which should be run with it's dependencies,
*										which in turn returns the uniSoc_common constructor function
*/e.exports=function(e={}){function t(e){throw new Error("Missing dependency for uniSoc: "+e)}const n=e.BetterUtil||t("BetterUtil"),r=e.BetterLog||t("BetterLog"),o=e.BetterEvents||t("BetterEvents");function i(e){if("string"==typeof e?e={name:e}:"object"==typeof e&&"Object"==e.constructor.name||(e={}),e=Object.assign({},i.defaultOptions,this.constructor.defaultOptions,e),Object.defineProperty(this,"isUniSoc",{value:!0}),Object.defineProperty(this,"id",{enumerable:!0,value:e.id||Math.floor(1e7*Math.random())}),e.name||(e.name=this.constructor.name+"_"+this.id),Object.defineProperty(this,"options",{enumerable:!0,value:e}),Object.defineProperty(this,"log",{value:new r(this,e)}),o.call(this,{onerror:this.log.error}),Object.defineProperty(this,"endpoints",{enumerable:!0,value:{}}),Object.defineProperty(this,"sharedEndpoints",{enumerable:!0,value:[]}),"function"==typeof this.options.transmitErrors)this.onerror=this.options.transmitErrors;else switch(String(this.options.transmitErrors).toLowerCase()){case"tostring":case"string":this.onerror=function(e){e.error=error.toString()};break;case"onlyprimitive":case"ifprimitive":this.onerror=function(e){if(n.isPrimitive(e.error)){e.error=this.log.makeError(e.error);let t=`Sending 'Internal Error' as response to request ${e.id}.`;e.error.printed?this.log.trace(t):e.error.addHandling(t).exec(),e.error="Internal Error"}};break;case"none":case!1:this.onerror=function(e){e.error=this.log.makeError(e.error);let t=`Sending 'error' as response to request ${e.id}.`;e.error.printed?this.log.trace(t):e.error.addHandling(t).exec(),e.error="error"};break;default:var t=!0;this.onerror=function(e){t&&(t=!1,this.log.note("Remember, we are transmitting errors..."))}}this.beforetransmit=null,this.aftertransmit=null,this.onresponse=null,this.registerEndpoint("help",()=>Object.entries(this.listVisibleEndpoints()).map(([e,{args:t,description:n}])=>`${e}(${t})${n?" "+n:""}`).join("\n"))}function s(e){i.call(this,e),Object.defineProperty(this,"sentRequests",{enumerable:!0,value:{}}),Object.defineProperty(this.sentRequests,"length",{get:()=>Object.keys(this.sentRequests).length}),Object.defineProperty(this,"receivedRequests",{enumerable:!0,value:{}}),Object.defineProperty(this.receivedRequests,"length",{get:()=>Object.keys(this.receivedRequests).length}),Object.defineProperty(this,"EOM",{writable:!0,enumerable:!1,value:e.eom})}async function c(e){try{n.checkType("object",e),"string"!=typeof e.subject&&this.log.makeError("A string subject is required, got:",n.logVar(e.subject)).throw("EINVAL"),e.subject.includes("undefined")&&this.log.makeError('Illegal subject contained the string "undefined": '+e.subject).throw("EINVAL"),e.__uniSoc=!0,e.id="number"==typeof e.id?e.id:0;try{e.error=await e.error,e.data=await e.data}catch(t){e.error=t}if(e.error){if(e.data){let t="Got data and error. Sending the error and discarding";if("promise"==n.varType(e.data)){let n=this.log.makeEntry("warn",t+" promised data (see later log)").exec();e.data.then(e=>this.log.warn(`Discarded data from entry #${n.id}:`,e)).catch(e=>this.log.warn(`Discarded promise from entry #${n.id} rejected:`,e))}else this.log.warn(t+" this data:",e.data);e.data=null}this.onerror(e)}return"function"==typeof this.beforetransmit&&this.beforetransmit.call(this,e),this.log.makeEntry("debug","Payload ready:",e).addHandling("next step is transmitting...").exec(),e}catch(e){return this.log.makeError("Failed to prepare payload",e).reject()}}function a(e,t=0){for(var r=Math.floor(1e9*Math.random())+1;void 0!==this.sentRequests[r];)r+=1;var o=`Built request (${r}), response via `,i=this;if("function"==typeof e){o+="callback";var{resolve:s,reject:c,promise:a}=n.exposedPromise();a=a.then(()=>r,(function(e){return i.cancelRequest(r),Promise.reject(e)})),t&&(o+=`, active for ${t} ms`,setTimeout(()=>{this.sentRequests[r]&&(this.log.debug(`Request ${r} timed out after ${t} ms.`),this.cancelRequest(r))},t))}else{o+="promise";var{reject:l,promise:d,callback:e}=n.exposedPromise(),h=!1,s=()=>{h=!0};d=(d=n.promiseAlways(d,()=>{this.cancelRequest(r)})).catch((function(e){return h?i.log.makeError(e).addHandling(`This is an error-response to request ${r}`).reject():Promise.reject(e)})),t>0&&(o+=`, timeout in ${t} ms`,setTimeout(()=>{if(this.sentRequests[r]){var e=this.log.makeError(`Request (${r}) timed out after ${t} ms.`).setCode("timeout");l(e)}},t))}return this.log.makeEntry("trace",o).addHandling("next step is preparing payload...").exec(),this.sentRequests[r]=e,[r,a||d,s,c||l]}function l(e){if("function"!=typeof this.sentRequests[e.id])throw new Error(`Received response to non-existent request ${e.id}`);var t=`response to ${e.target}${function(e){var t=Object.assign(n.subObj(e,"rinfo")||{},n.subObj(e,["ip","hostname","host","address","port"],!0)),r=t.address||t.host||t.hostname||t.ip||"",o=t.port||"";return r||o?` from ${r}:${o}`:""}(e)}`;null==e.error?(this.log.debug(`${e.id}: Received successfull ${t}:`,e.data),"function"==typeof this.onresponse&&this.onresponse.call(this,e)):this.log.note(`${e.id}: Received failed ${t}:`,this.log.makeError(e.error).toString()),"cancel"===this.sentRequests[e.id].call(null,e.error,e.data,e)&&(this.log.debug("responseCallback returned 'cancel', cancelling request...."),this.cancelRequest(e.id))}async function d(e,t,n){var r=!0;try{this.log.traceFunc(arguments,`${e.id}: `),e.target=e.subject,e.subject="__uniSoc_response",e.error=arguments.length>1?t:e.error,e.data=arguments.length>2?n:e.data,"__uniSoc_EALREADY"==t?e.error={code:"EALREADY",msg:"You already have an outstanding request with ID "+e.id+", please increment id or wait for response before requesting again"}:delete this.receivedRequests[e.id],await this.send(e)}catch(t){this.log.error(`Failed to respond to request ${e.id}`,t),r=!1}try{this.receivedRequests.length||this.emit("_waiting")}catch(e){this.log.error("BUGBUG:",e)}return r}function h(e){s.call(this,e),Object.defineProperty(this,"connected",{enumerable:!0,get:()=>this.socket&&this.socket.readyState==this.socket.OPEN}),this.log.codes={1e3:"Socket closed normally (this is the expected behavior).",1001:"The socket is closing (eg. client is closing browser tab).",1005:"Status code missing (ie. received a closing frame without status code).",1006:"Connection closed unexpectedly (ie. no closing frame received at all)",1002:"Protocol error (ie. received a frame that doesn't adhere to Websocket standard).",1007:"Inconsistent data type (e.g. non-UTF-8 data within a text message).",1003:"Policy violation: Unsupported data type (e.g. endpoint only understands text data, but received binary).",1009:"Policy violation: Too much data (ie. message is too big to handle.).",1008:"Policy violation: Generic",1010:"Server doesn't support extension demanded by client",1011:"Internal server error",1012:"Server is restarting",1013:"Server is temporarily unable to fullfil client's request, try again later.",1014:"Bad gateway (gateway received an invalid response)",1015:"TLS handshake fail"}}return i.defaultOptions={eom:"__EOM__",transmitErrors:"all"},i.prototype=Object.create(o.prototype),Object.defineProperty(i.prototype,"constructor",{value:i}),i.prototype.close=i.prototype.disconnect=i.prototype.shutdown=i.prototype.terminate=i.prototype.kill=function(e){if(this instanceof i)return this.connected?"function"==typeof this._kill?(this.log.trace("Going to close socket..."),Promise.resolve(this._kill()).catch(this.log.error).then(()=>{this.emitOnce("_disconnect",e)})):this.log.reject("BUGBUG: no disconnect function set"):(this.alreadyEmitted("_connect")?this.alreadyEmitted("_disconnect")||(this.log.warn("Possible EDGE CASE. .kill() was called, we're not connected, but _disconnect has not been emitted. Doing so now..."),this.emit("_disconnect",e)):this.log.info("Not yet connected, so won't emit _disconnect..."),Promise.resolve());r._syslog.reject("BUGBUG: disconnect() called in non-instance scope, cannot disconnect. this:",this)},i.prototype.registerEndpoint=function(e,t,r={}){try{if(n.checkTypes(["string","function","object"],[e,t,r]),this.hasEndpoint(e,"localOnly"))throw"EEXISTS";var o=r.argNames||t._argNames;if(!o)try{o=n.getArgNames.call(this,t,!0)}catch(t){log.warn(`Endpoint '${e}' will not support named args.`,t)}var i=t._length||t.length,s={};Array.isArray(o)?(o=n.filterSplit(o,e=>null==e.match(/(callback|payload|unisoc)/),"retainIndex"),s.args=Object.values(o).join(", "),i-=Object.values(o.rest).length):(s.args=i=r.reqArgCount||t._reqArgCount||i,o=!1);let c=r.description||t._description;return"string"==typeof c&&(s.description=c),s.listener=function(s,c){try{var a,l,d=this.log.makeEntry("note",`${s.id}: Calling endpoint: ${e}`);switch(n.varType(s.data)){case"array":a=s.data;break;case"object":o||this.log.makeError("This endpoint doesn't support named args. Try consulting docs...").throw("EINVAL"),a=o.map(e=>s.data[e]);break;case"string":case"number":case"boolean":case"null":a=[s.data];break;case"undefined":a=[];break;default:this.log.makeError("BUGBUG: unexpected payload.data: ",n.logVar(s.data)).throw("EINVAL")}a.length<i&&this.log.makeError(`Command requires ${i} args minimum, only got ${a.length}.`).throw("EINVAL"),o&&o.rest.length&&o.rest.forEach((e,t)=>{switch(e){case"callback":return"function"==typeof c?(!0,d.addHandling("Including response callback. If it's not called, then no response will be sent")):(d.lvl=5,d.addHandling("option.callback being ignored because no response requested")),void(a[t]=c);case"payload":return d.addHandling("Including live payload. You can set additional props on it before sending"),void(a[t]=s);case"unisoc":d.addHandling("Including receiving uniSoc"),a[t]=this}}),d.extra.push("( "+(a.length?a.map(e=>n.logVar(e,50)).join(", "):"<void>")+" )"),d.exec(),l=n.applyPromise(t,a,r.callAs)}catch(e){"EINVAL"==(e=this.log.makeError(e)).code?(e.exec(),l=Promise.reject(e.toString())):l=e.reject()}var h=s.id?s.id+": ":"",u=this.log;"function"==typeof c?(o&&o.rest.includes("callback")||(l=l.then((function(e){c(null,e)}),(function(e){c(e)}))),l.catch((function(e){u.error(`${h}Failed to return request reponse`,e)}))):l.then((function(e){void 0!==e&&u.note(`${h}Endpoint returned data but none was expected:`,e)}),(function(e){u.error(`${h}Endpoint call failed.`,e)}))},s.visible=!r.secret,this.endpoints[e]=s,this.log.debug(`Added ${r.secret?"secret ":""}endpoint: ${e}(${s.args})`),e}catch(t){throw this.log.error("Failed to register method:",e,t)}},i.prototype.getEndpoint=function(e,t=!1){n.checkType("string",e);try{var r,o;if(this.endpoints.hasOwnProperty(e))o="local",r=this.endpoints[e];else if(!t)for(var i in this.sharedEndpoints){let t=this.sharedEndpoints[i];if("function"==typeof t.getEndpoint?(o="shared"+(t.isUniSoc?" (from "+t.options.name:"(function")+")",r=t.getEndpoint(e)):t.hasOwnProperty(e)&&(o="shared",r=t[e]),r)break}return!r||"object"==typeof r&&"function"==typeof r.listener?r:void this.log.error(`Unexpected ${o} endpoint '${e}'. Got:`,n.logVar(r))}catch(t){return void this.log.error(`BUGBUG: Failed to get endpoint '${e}'`,t,{ep:r,source:o})}},i.prototype.listVisibleEndpoints=function(){var e=n.subObj(this.endpoints,(e,t)=>t.visible);return this.sharedEndpoints.forEach(t=>{var n,r="function"==typeof t.listVisibleEndpoints?t.listVisibleEndpoints():t;for(n in r)r[n].visible&&!e.hasOwnProperty(n)&&(e[n]=r[n])}),e},i.prototype.hasEndpoint=function(e,t){return!!this.getEndpoint(e,t)},i.prototype.unregisterEndpoint=function(e){delete this.endpoints[e]},i.prototype.registerSharedEndpoints=function(e){if(n.checkType("object",e),"function"==typeof e.getEndpoint&&"function"==typeof e.listVisibleEndpoints)this.sharedEndpoints.includes(e)||this.sharedEndpoints.push(e);else{var t,r={};for(t in e)e[t].hasOwnProperty("listener")&&(r[t]=n.extract(e[t],["listener","description","args","visible"]));this.sharedEndpoints.push(r)}},i.prototype.registerEndpointsForObject=function(e,t,r={}){n.checkTypes(["object","string","object"],[e,t,r]);var o=[],i=Object.keys(e);if(Array.isArray(r.ignore)&&(i=i.filter(e=>!(r.ignore.indexOf(e)>-1)||(o.push(e),!1))),!i.length)return this.log.warn("No props are going to be registered from: ",e),[];this.log.debug("Registering props as endpoints: "+i.join(",")+(o.length?". Ignoring these: "+o.join(","):""));var s=[];return i.forEach(n=>{var o=Object.assign({callAs:e},r._all,r[n]),i=`/${t}/${n}`;if("function"==typeof e[n])s.push(this.registerEndpoint(i,e[n],o));else{var c=Object.getOwnPropertyDescriptor(e,n);c.hasOwnProperty("value")?(s.push(this.registerEndpoint(`${i}/get`,(function(){return e[n]}),o)),c.writable&&s.push(this.registerEndpoint(`${i}/set`,(function(t){return e[n]=t}),o))):(c.get&&s.push(this.registerEndpoint(`${i}/get`,c.get,o)),c.set&&s.push(this.registerEndpoint(`${i}/set`,c.get,o)))}}),s},i.prototype.createProxyFromEndpoints=function(e){n.checkType("array",e);var t={};return e.forEach(e=>{try{var n=e.split("/");if(n.length<2)return;var r=n.pop(),o=!1;if("set"!=r&&"get"!=r||(o=r,r=n.pop()),!r)return void this.log.warn("Unexpected endpoint, skipping:",e);let i=n.join("/");t.hasOwnProperty(i)||(t[i]={}),"set"==o?Object.defineProperty(t[i],r,{enumerable:!0,configurable:!0,set:t=>this.request(e,t)}):"get"==o?Object.defineProperty(t[i],r,{enumerable:!0,configurable:!0,get:()=>this.request(e)}):Object.defineProperty(t[i],r,{enumerable:!0,value:(...t)=>this.request(e,t.length?t:void 0)})}catch(t){this.log.error(`Failed to add endpoint ${e}' to proxy obj.`,t)}}),t},i.prototype.getRemoteEndpoints=function(){return this.request("help")},s.prototype=Object.create(i.prototype),Object.defineProperty(s.prototype,"constructor",{value:s}),i.prototype.parseArgs=function(e){if(1==e.length&&"object"==typeof e[0]&&e[0].hasOwnProperty("subject"))var t=e[0];else t={callback:n.getFirstOfType(e,"function",!0),subject:e.shift(),data:1==e.length?e[0]:e.length?e:void 0};return t},s.prototype.afterTransmit=function(e,t,r,o){var i="Failed to transmit";if(e&&e.toString().match(i))return this.log.makeEntry(e).reject();var s="",c="__uniSoc_response"==t.subject?"response":"message";return t.id&&(this.sentRequests[t.id]&&(c="request"),s=t.id+": "),(r||o)&&(c+=` to ${r||""}:${o||""}`),e?this.log.makeError(`${i} ${c}:`,e).reject():(this.log.info(`${s}Successfully sent ${c}:`,"subject: "+(t.target||t.subject)+"\n","error: "+n.logVar(t.error),"data: "+n.logVar(t.data)),"function"==typeof this.aftertransmit&&this.aftertransmit.call(this,t),!0)},s.prototype.send=function(...e){var{_transmit:t,...n}=this.parseArgs.call(this,e);return this.connected?c.call(this,n).then(e=>t?t(e):this._transmit(e)):(this.disconnect("EPIPE"),this.log.makeError("Socket is not open, failed to send...").setCode("EPIPE").reject())},s.prototype.request=function(...e){var{callback:t,timeout:n,_transmit:r,...o}=this.parseArgs.call(this,e);if(!this.connected)return this.disconnect("EPIPE"),this.log.makeError("Socket is not open, failed to send...").setCode("EPIPE").reject();var[i,s,l,d]=a.call(this,t,n);return o.id=i,c.call(this,o).then(e=>r?r(e):this._transmit(e)).then(l,d),s},s.prototype.cancelRequest=function(e){try{if(this.log.traceFunc(arguments,"cancelRequest"),"number"==n.checkType(["number","function"],e)){if(this.sentRequests[e])return delete this.sentRequests[e],!0;this.log.warn("No pending request with id: ",e)}else{var t=this.sentRequests.indexOf(e);if(t>-1)return delete this.sentRequests[t],this.sentRequests.indexOf(e)>-1&&this.log.note("More than one instance of callback registered, only deleted first.",e),!0;this.log.warn("No pending request with callback: ",e)}}catch(e){this.log.error("Error trying to cancel request",e)}return!1},s.prototype.receive=function(e){try{n.checkProps(e,{subject:"string"}),e.id=Number(e.id)||0;var t="";if(e.id){if("__uniSoc_response"==e.subject)return void l.call(this,e);t=e.id+": ",this.log.debug(`${t}Received request:`,e);var r=n.once(d.bind(this,e),()=>this.log.makeEntry("warn","responseCallback() called multiple times! This time").changeWhere(1).addFrom().exec());if(this.receivedRequests.hasOwnProperty(e.id))return void r("__uniSoc_EALREADY");this.receivedRequests.length||this.emit("_working"),this.receivedRequests[e.id]=r}else this.log.debug("Received message (no response expected):",e);var o=this.getEndpoint(e.subject);if(o)o.listener.call(this,e,r);else{var i=this.countListeners(e.subject,!0),s=`for '${e.subject}' ${r?"with":"without"} callback`;i?(this.log.info(i>0?`${t}Calling ${i} listeners ${s}`:`${t}Calling ${-1*i} onAll/onUnhandled listeners ${s}`),this.emitEvent(e.subject,[e.data,r,e.payload])):(this.log.warn(`${t}New message on subject '${e.subject}' received, but no handler registered. Payload:`,e),r&&r("404 Not Found"))}return}catch(t){this.log.makeError(t).addHandling("Error while handling incoming message:",e).exec()}},s.prototype.extendEvents=function(e,t={}){n.checkTypes(["object","object"],[e,t]),"function"==typeof e.on&&"function"==typeof e.emit||this.log.throwType("emitter object with .on() and .emit()",e);var r,o,i,s="Extending",{include:c,exclude:a,subject:l,prefix:d}=t;if(a?(a=[].concat(a),s+=` all events except '${evts.join("','")}'`,r=e=>-1==a.indexOf(e)):c?(c=[].concat(c),s+=` events '${evts.join("','")}'`,r=e=>c.indexOf(e)>-1):(s+=" all events",r=()=>!0),"object"==typeof e._betterEvents?(s+=" (responses ENABLED)",o=this.request):(s+=" (responses DISABLED)",o=this.send),d?(s+=" using prefix ",i=((e,...t)=>{if(this.connected&&r(e))return o.call(this,{subject:`${d}/${e}`,data:t})}).bind(this)):l?(s+=" using single subject ",i=((...e)=>{if(this.connected&&r(e[0]))return o.call(this,{subject:l,data:e})}).bind(this)):log.throw("Arg #2 must contain either 'prefix' or 'subject' option"),s+=`'${l}'`,this.log.debug(s,e),"object"==typeof e._betterEvents)return e.onAll(i),this.on("_disconnect",()=>e.removeListeners(i)),i;{this.log.note("Intercepting all calls to .emit() on:",e);var h=e.emit;function u(...t){return i.apply(null,t),h.apply(e,t)}return Object.defineProperty(e,"emit",{value:u,writable:!0,configurable:!0,enumerable:e.propertyIsEnumerable("emit")}),void this.on("_disconnect",()=>{e.emit==u&&delete e.emit})}},h.prototype=Object.create(s.prototype),Object.defineProperty(h.prototype,"constructor",{value:h}),h.prototype.registerAllListeners=function(){return this.socket?"number"!=typeof this.socket.readyState?this.log.throwType("this.socket to be instance of ws/Websocket",this.socket):this.socket.onclose?this.log.warn("Listeners already set on this.socket").setCode("EALREADY").exec():(this.log.debug("Regisering listners on websocket..."),this.clearEmitted("_connect"),this.clearEmitted("_disconnect"),this.connected?(this.log.debug("Websocket was already connected..."),this.emitOnce("_connect")):this.socket.onopen=()=>{this.log.debug("Websocket just connected now!"),this.connected||this.log.error("BUGBUG: We just connected, but this.connected is:",this.connected),this.emitOnce("_connect")},this.socket.onclose=e=>{var t=this.log.makeCodeError(e.code,e.reason);e.wasClean?(t.prepend("Websocket closed cleanly.").changeLvl("debug").exec(),this.on("_disconnect",()=>console.log("YUP, got _disconnect here...")),this.alreadyEmitted("_disconnect")&&this.log.warn("BUGBUG: _disconnect has already been emitted, but the socket JUST CLOSED..."),this.emitOnce("_disconnect")):(this.alreadyEmitted("_connect")?t.prepend("Websocket closed.").exec():t.prepend("Websocket failed to open.").setCode("CONN_FAIL",!0),this.emitOnce("_disconnect",t))},this.socket.onerror=e=>{this.connected&&this.log.warn("Error occured, but connection still active:",e)},this.socket.onmessage=e=>{try{var t=JSON.parse(e.data)}catch(t){let n=t.message.replace("SyntaxError:","");return void this.log.makeEntry("warn","Received badly formated JSON in message:",n,"\n",e.data).setCode("SyntaxError").exec()}this.receive(t)}):this.log.makeError("You cannot register listeners before having created/set this.socket").setCode("ESEQ").exec().throw(),this},h.prototype._kill=function(){if(!this.socket||this.socket.readyState==this.socket.CLOSED)return Promise.resolve();if(this.socket.readyState==this.socket.CONNECTING)return n.sleep(100).then(()=>this._kill());var{promise:e,resolve:t}=n.exposedPromise(3e3);return this.socket.addEventListener("close",t),this.socket.readyState!=this.socket.CLOSING&&this.socket.close(),e.catch(e=>{if("timeout"!=e)return Promise.reject(e);if(this.socket&&this.socket.readyState!=this.socket.CLOSED){let e="Socket still not closed after 3 sec";this.socket.terminate?(this.log.warn(e+", forcing it..."),this.socket.terminate()):this.log.warn(e+"...")}else this.log.note("BUGBUG: socket closed but 'close' event didn't fire...")})},h.prototype._transmit=function(e){let t=JSON.stringify(e);this.log.trace("Transmitting...",n.logVar(t,50,"noLog")),this.socket.send(t,t=>this.afterTransmit(t,e))},i.Client=s,i.Websocket=h,i}}]);